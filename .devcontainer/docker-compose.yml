services:
  app:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ..:/workspace:cached
      - node_modules:/workspace/node_modules
    environment:
      DATABASE_URL: postgres://app:devpassword@postgres:5432/app
      REDIS_URL: redis://redis:6379
      S3_ENDPOINT: http://minio:9000
      S3_BUCKET: app-dev
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: minioadmin
      SMTP_HOST: mailpit
      SMTP_PORT: 1025
      MEILI_URL: http://meilisearch:7700
      MEILI_KEY: devkey
      QUEUE_PROVIDER: bullmq
      AUTH_PROVIDER: lucia
      STORAGE_PROVIDER: minio
      NODE_ENV: development

  postgres:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: app
      POSTGRES_USER: app
      POSTGRES_PASSWORD: devpassword
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s

  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - miniodata:/data

  mailpit:
    image: axllent/mailpit

  meilisearch:
    image: getmeili/meilisearch:v1.11
    environment:
      MEILI_MASTER_KEY: devkey
    volumes:
      - meilidata:/meili_data

volumes:
  node_modules:
  pgdata:
  miniodata:
  meilidata:
