name: Cleanup Preview
on:
  pull_request:
    types: [closed]

jobs:
  # Gate: check whether AWS credentials are configured.
  # Mirrors the check-secrets job in deploy-preview.yml so cleanup
  # produces a safe, explainable skip rather than a noisy failure
  # when credentials are absent (e.g. forks, new repos).
  check-secrets:
    runs-on: ubuntu-latest
    outputs:
      has-aws: ${{ steps.check.outputs.has-aws }}
    steps:
      - id: check
        env:
          AWS_ROLE: ${{ secrets.AWS_ROLE_ARN }}
        run: |
          if [ -n "$AWS_ROLE" ]; then
            echo "has-aws=true" >> "$GITHUB_OUTPUT"
          else
            echo "has-aws=false" >> "$GITHUB_OUTPUT"
            echo "::notice::Skipping preview cleanup â€” AWS_ROLE_ARN secret is not configured"
          fi

  cleanup:
    needs: [check-secrets]
    if: needs.check-secrets.outputs.has-aws == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-southeast-2
      - run: npx sst remove --stage pr-${{ github.event.pull_request.number }}
