name: Fleet Sync PRs
on:
  workflow_dispatch:
    inputs:
      target-repo:
        description: 'Target repository (owner/repo) to sync'
        required: true
        type: string
      target-ref:
        description: 'Target repository default branch'
        required: false
        default: 'main'
        type: string
      severity-filter:
        description: 'Minimum severity to sync (security-critical, standards-required, recommended)'
        required: false
        default: 'standards-required'
        type: choice
        options:
          - security-critical
          - standards-required
          - recommended
      dry-run:
        description: 'Preview sync without creating PR'
        required: false
        default: false
        type: boolean
  workflow_run:
    workflows: ['Fleet Drift Detection']
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Generate sync PR
    runs-on: ubuntu-latest
    # Only run on workflow_dispatch or when drift detection completed successfully
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure')
    steps:
      - name: Checkout golden-path source
        uses: actions/checkout@v4
        with:
          path: golden-path

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target-repo || '' }}
          ref: ${{ inputs.target-ref || 'main' }}
          path: target-repo
          token: ${{ secrets.FLEET_SYNC_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: golden-path/.nvmrc

      - name: Run drift detection
        id: drift
        working-directory: golden-path
        run: |
          node scripts/check-fleet-drift.mjs --target=../target-repo --json > ../drift-report.json 2>/dev/null || true
          SCORE=$(node -e "process.stdout.write(String(JSON.parse(require('fs').readFileSync('../drift-report.json','utf-8')).complianceScore))")
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"
          DRIFTED=$(node -e "const r=JSON.parse(require('fs').readFileSync('../drift-report.json','utf-8'));process.stdout.write(String(r.summary.drifted+r.summary.missing))")
          echo "drifted=$DRIFTED" >> "$GITHUB_OUTPUT"

      - name: Generate sync plan
        if: steps.drift.outputs.drifted != '0'
        working-directory: golden-path
        run: |
          if [ "${{ inputs.dry-run }}" = "true" ]; then
            node scripts/fleet-sync.mjs --report=../drift-report.json --dry-run --json > ../sync-plan.json
          else
            node scripts/fleet-sync.mjs --target=../target-repo --report=../drift-report.json --json > ../sync-plan.json
          fi

      - name: Create sync branch
        if: steps.drift.outputs.drifted != '0' && inputs.dry-run != true
        working-directory: target-repo
        run: |
          BRANCH="fleet/sync-$(date +%Y%m%d)"
          git checkout -b "$BRANCH"
          git config user.name "Fleet Sync Bot"
          git config user.email "fleet-sync@ripple.vic.gov.au"
          git add -A
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "fleet: sync governed surfaces from golden path

          Compliance score: ${{ steps.drift.outputs.score }}%
          Surfaces with drift: ${{ steps.drift.outputs.drifted }}
          Generated by Fleet Sync (RN-024)"
          git push -u origin "$BRANCH"
          echo "SYNC_BRANCH=$BRANCH" >> "$GITHUB_ENV"

      - name: Create pull request
        if: steps.drift.outputs.drifted != '0' && inputs.dry-run != true && env.SYNC_BRANCH != ''
        working-directory: target-repo
        env:
          GH_TOKEN: ${{ secrets.FLEET_SYNC_TOKEN }}
        run: |
          PR_BODY=$(node -e "process.stdout.write(JSON.parse(require('fs').readFileSync('../sync-plan.json','utf-8')).prBody)")
          gh pr create \
            --title "fleet: sync governed surfaces from golden path" \
            --body "$PR_BODY" \
            --label "fleet:sync" \
            --base "${{ inputs.target-ref || 'main' }}" \
            --head "$SYNC_BRANCH"

      - name: Upload sync plan
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fleet-sync-plan
          path: sync-plan.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Summary
        if: always()
        run: |
          echo "## Fleet Sync Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ inputs.dry-run }}" = "true" ]; then
            echo "> **Dry run** â€” no changes were made" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Compliance Score | ${{ steps.drift.outputs.score }}% |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Surfaces with Drift | ${{ steps.drift.outputs.drifted }} |" >> "$GITHUB_STEP_SUMMARY"
