{
  "name": "add-api-endpoint",
  "description": "Scaffold and implement a new oRPC endpoint with Zod validation, authentication, OpenAPI metadata, and tests.",
  "args": {
    "router": "Router name in kebab-case (e.g. 'project', 'user', 'content')",
    "procedure": "Procedure name in camelCase (e.g. 'getById', 'create', 'listAll')"
  },
  "preconditions": [
    {
      "description": "oRPC router directory exists",
      "command": "test -d apps/web/server/orpc/routers",
      "expect": "exit 0"
    },
    {
      "description": "Environment passes doctor checks",
      "command": "pnpm doctor -- --json",
      "expect": "exit 0"
    }
  ],
  "steps": [
    {
      "order": 1,
      "command": "pnpm generate:endpoint ${ROUTER} ${PROCEDURE}",
      "description": "Scaffold oRPC router (if new), procedure stub, and test file"
    },
    {
      "order": 2,
      "command": "echo 'Define Zod input/output schemas in the router file'",
      "description": "Replace placeholder z.object({}) with actual validation schemas. Share schemas from packages/validation/ if applicable."
    },
    {
      "order": 3,
      "command": "echo 'Implement procedure logic using repository pattern'",
      "description": "Use context.db to create repository instances. Never access the database directly from route handlers."
    },
    {
      "order": 4,
      "command": "echo 'Set visibility metadata: public (versioned, gated) or internal'",
      "description": "Public endpoints get /v1/ path prefix and are published to the OpenAPI spec. Internal endpoints are excluded."
    },
    {
      "order": 5,
      "command": "echo 'Write tests with createRouterClient and mock context'",
      "description": "Test happy path, validation errors, auth failures, and edge cases. Use factories from packages/testing/factories/."
    },
    {
      "order": 6,
      "command": "pnpm test -- --filter @ripple/web",
      "description": "Run web app tests to verify the new endpoint"
    },
    {
      "order": 7,
      "command": "pnpm generate:openapi",
      "description": "Regenerate the OpenAPI spec to include the new endpoint"
    },
    {
      "order": 8,
      "command": "pnpm typecheck",
      "description": "Verify end-to-end type safety (oRPC infers types from Zod schemas)"
    },
    {
      "order": 9,
      "command": "pnpm lint",
      "description": "Verify lint passes"
    }
  ],
  "validation": [
    {
      "description": "Router file exists",
      "command": "test -f apps/web/server/orpc/routers/${ROUTER}.ts",
      "expect": "exit 0"
    },
    {
      "description": "Router registered in router.ts",
      "command": "grep -q '${ROUTER}' apps/web/server/orpc/router.ts",
      "expect": "exit 0"
    },
    {
      "description": "Test file exists",
      "command": "test -f apps/web/tests/unit/orpc/${ROUTER}-router.test.ts",
      "expect": "exit 0"
    },
    {
      "description": "OpenAPI spec is in sync",
      "command": "pnpm check:api-contract",
      "expect": "exit 0"
    },
    {
      "description": "Tests pass",
      "command": "pnpm test -- --filter @ripple/web",
      "expect": "exit 0"
    }
  ],
  "conventions": {
    "authentication": "Use protectedProcedure for authenticated endpoints, pub for public",
    "validation": "Always validate input with Zod schemas â€” no raw input access",
    "database": "Access via repository pattern: const repo = new XxxRepository(context.db)",
    "errors": "Use ORPCError with appropriate code (NOT_FOUND, UNAUTHORIZED, CONFLICT)",
    "routing": "Use .route({ method, path, tags }) and .meta({ visibility }) on every procedure",
    "openapi": "Regenerate spec after changes: pnpm generate:openapi"
  },
  "related": [
    "apps/web/server/orpc/routers/",
    "apps/web/server/orpc/base.ts",
    "apps/web/server/orpc/router.ts",
    "packages/validation/",
    "packages/db/repositories/",
    "scripts/generate/endpoint.mjs",
    "docs/adr/021-api-contract-strategy.md"
  ]
}
