{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Ripple Fleet Governance Policy",
  "description": "Machine-readable fleet governance contract defining governed surfaces, sync strategies, and exception workflow. See ADR-019 and RN-024.",
  "version": "1.3.0",
  "schema": "ripple-fleet-policy/v1",
  "governedSurfaces": [
    {
      "id": "FLEET-SURF-001",
      "name": "ci-workflows",
      "description": "CI pipeline structure and quality gates",
      "strategy": "sync",
      "severity": "standards-required",
      "paths": [".github/workflows/ci.yml", ".github/workflows/security.yml", ".github/workflows/reusable-quality.yml", ".github/workflows/reusable-test.yml", ".github/workflows/reusable-security.yml"],
      "checksumValidation": true,
      "taxonomyCode": "RPL-FLEET-002"
    },
    {
      "id": "FLEET-SURF-002",
      "name": "composite-actions",
      "description": "Reusable CI composite actions (setup, quality, test)",
      "strategy": "sync",
      "severity": "security-critical",
      "paths": [".github/actions/setup/action.yml", ".github/actions/quality/action.yml", ".github/actions/test/action.yml"],
      "checksumValidation": true,
      "taxonomyCode": "RPL-FLEET-001"
    },
    {
      "id": "FLEET-SURF-003",
      "name": "toolchain-pinning",
      "description": "Node.js and pnpm version pinning files",
      "strategy": "sync",
      "severity": "security-critical",
      "paths": [".nvmrc"],
      "fields": [
        { "file": "package.json", "key": "packageManager" },
        { "file": "package.json", "key": "engines" }
      ],
      "taxonomyCode": "RPL-FLEET-001"
    },
    {
      "id": "FLEET-SURF-004",
      "name": "quality-scripts",
      "description": "Quality gate check scripts for readiness, quarantine, and unified verify",
      "strategy": "sync",
      "severity": "standards-required",
      "paths": ["scripts/check-readiness.mjs", "scripts/check-quarantine.mjs", "scripts/verify.mjs"],
      "checksumValidation": true,
      "taxonomyCode": "RPL-FLEET-002"
    },
    {
      "id": "FLEET-SURF-005",
      "name": "eslint-config",
      "description": "Shared ESLint configuration (no-console error, no-explicit-any error)",
      "strategy": "merge",
      "severity": "standards-required",
      "paths": ["eslint.config.js"],
      "taxonomyCode": "RPL-FLEET-002"
    },
    {
      "id": "FLEET-SURF-006",
      "name": "security-config",
      "description": "Security workflow and code ownership configuration",
      "strategy": "sync",
      "severity": "security-critical",
      "paths": [".github/workflows/security.yml", ".github/CODEOWNERS"],
      "checksumValidation": true,
      "taxonomyCode": "RPL-FLEET-001"
    },
    {
      "id": "FLEET-SURF-007",
      "name": "iac-policies",
      "description": "Infrastructure-as-code policy definitions and scanner for government security posture",
      "strategy": "sync",
      "severity": "security-critical",
      "paths": ["docs/iac-policies.json", "scripts/iac-policy-scan.mjs"],
      "checksumValidation": true,
      "rationale": "Government platform security posture must be consistent across fleet",
      "taxonomyCode": "RPL-FLEET-001"
    },
    {
      "id": "FLEET-SURF-008",
      "name": "error-taxonomy",
      "description": "Machine-parseable error codes for AI agent auto-triage across fleet",
      "strategy": "sync",
      "severity": "standards-required",
      "paths": ["docs/error-taxonomy.json"],
      "checksumValidation": true,
      "rationale": "AI agents across the fleet must speak the same error language for cross-repo triage",
      "taxonomyCode": "RPL-FLEET-002"
    },
    {
      "id": "FLEET-SURF-009",
      "name": "action-version-pinning",
      "description": "Workflow files must reference ripple-next actions/workflows with pinned version refs (@v1, @v1.x.x, or SHA), not floating @main",
      "strategy": "advisory",
      "severity": "recommended",
      "paths": [".github/workflows/"],
      "contentPatterns": [
        {
          "pattern": "ripple-next/\\.github/(?:actions|workflows)/[^@]+@main",
          "message": "Unpinned @main ref found — use @v1 or a SHA for deterministic CI"
        }
      ],
      "rationale": "Unpinned @main refs cause non-deterministic fleet behaviour and surprise breakage (RN-048)",
      "taxonomyCode": "RPL-FLEET-003"
    },
    {
      "id": "FLEET-SURF-010",
      "name": "ai-agent-instructions",
      "description": "AI agent instruction files — CLAUDE.md, AGENTS.md, copilot-instructions, GitHub instructions, agents, and prompts",
      "strategy": "advisory",
      "severity": "recommended",
      "paths": ["CLAUDE.md", "AGENTS.md", ".github/copilot-instructions.md", ".github/instructions/*.instructions.md", ".github/agents/*.agent.md", ".github/prompts/*.prompt.md"],
      "rationale": "AI agent quality is proportional to instruction quality. Downstream repos customise these, so advisory strategy reports divergence without auto-overwriting. Agents evaluate and adopt selectively (ADR-022, RN-052).",
      "taxonomyCode": "RPL-FLEET-003"
    },
    {
      "id": "FLEET-SURF-011",
      "name": "fleet-governance-tooling",
      "description": "Fleet governance scripts and policy files that must be consistent for drift detection to work correctly",
      "strategy": "sync",
      "severity": "standards-required",
      "paths": ["scripts/check-fleet-drift.mjs", "docs/fleet-policy.json", ".github/actions/fleet-drift/action.yml"],
      "checksumValidation": true,
      "rationale": "When new governed surfaces are added (e.g., SURF-010), downstream drift detection scripts must also update to check them (ADR-022, RN-052).",
      "taxonomyCode": "RPL-FLEET-002"
    },
    {
      "id": "FLEET-SURF-012",
      "name": "downstream-documentation",
      "description": "Product roadmap structure, architecture documentation, and readiness.json content quality for downstream repos",
      "strategy": "advisory",
      "severity": "recommended",
      "paths": [
        "docs/product-roadmap/README.md",
        "docs/architecture.md",
        "docs/readiness.json"
      ],
      "contentPatterns": [
        {
          "pattern": "TODO: Add your|placeholder|Phase 1|Phase 2",
          "message": "Documentation contains placeholder content — replace with real project content. See docs/downstream-adoption-guide.md",
          "expect": "absent"
        },
        {
          "pattern": "## (Now|Next|Later|Done)",
          "message": "Product roadmap should use Now/Next/Later structure",
          "expect": "present",
          "scope": "docs/product-roadmap/README.md"
        }
      ],
      "rationale": "Downstream repos must produce meaningful documentation for AI agents and teams to understand what the repo builds. Advisory enforcement reports gaps without blocking CI. See ADR-023.",
      "taxonomyCode": "RPL-ADOPT-001"
    },
    {
      "id": "FLEET-SURF-013",
      "name": "api-contract-documentation",
      "description": "API contract documentation for downstream repos with API endpoints. Advisory only — not required for repos without API surfaces.",
      "strategy": "advisory",
      "severity": "recommended",
      "paths": [
        "docs/api-contracts.md",
        "docs/api/openapi.json"
      ],
      "contentPatterns": [
        {
          "pattern": "\\|.*Method.*\\|.*Path.*\\|",
          "message": "API contracts should include an endpoint table with method, path, visibility, and auth",
          "expect": "present",
          "scope": "docs/api-contracts.md"
        }
      ],
      "rationale": "Repos with API endpoints must document their contracts for discoverability and AI agent reasoning. Advisory strategy means this only reports — it does not block builds. See ADR-021 and ADR-023.",
      "taxonomyCode": "RPL-ADOPT-003"
    }
  ],
  "localOverrides": [
    "sst.config.ts",
    "apps/",
    "services/",
    "packages/*/providers/*.ts",
    ".env",
    ".env.example",
    "docs/readiness.json",
    "docs/product-roadmap/",
    "pnpm-lock.yaml"
  ],
  "syncPolicy": {
    "security-critical": {
      "action": "pr-immediate",
      "autoMerge": false,
      "label": "fleet:security",
      "sla": "Fix within 7 days"
    },
    "standards-required": {
      "action": "pr-weekly",
      "autoMerge": false,
      "label": "fleet:standards",
      "sla": "Fix within 30 days"
    },
    "recommended": {
      "action": "report-only",
      "label": "fleet:advisory",
      "sla": "No SLA"
    }
  },
  "exceptionWorkflow": {
    "description": "Fleet policy exceptions require explicit inline comments in the drifted file",
    "commentFormat": "// fleet-policy-exception: <SURFACE-ID> — <justification>",
    "requirements": [
      "Exception comment must be in a file within the governed surface scope",
      "Justification must explain why the exception is safe",
      "Exceptions are tracked in fleet drift reports",
      "Exceptions expire after 90 days and must be renewed"
    ],
    "expiryDays": 90
  },
  "complianceTargets": {
    "minimumScore": 80,
    "securityCriticalDrifts": 0,
    "standardsDriftsMax": 2
  },
  "feedbackPolicy": {
    "description": "Downstream→upstream feedback system for bidirectional fleet communication (ADR-022, RN-052)",
    "schema": "ripple-fleet-feedback/v1",
    "feedbackTypes": ["feature-request", "bug-report", "policy-exception", "improvement-share", "pain-point"],
    "issueLabels": {
      "base": "fleet:feedback",
      "perType": {
        "feature-request": "fleet:feedback:feature-request",
        "bug-report": "fleet:feedback:bug-report",
        "policy-exception": "fleet:feedback:policy-exception",
        "improvement-share": "fleet:feedback:improvement-share",
        "pain-point": "fleet:feedback:pain-point"
      }
    },
    "severityLabels": {
      "critical": "priority:critical",
      "high": "priority:high",
      "medium": "priority:medium",
      "low": "priority:low"
    },
    "deduplicationWindow": "30d",
    "triageSla": {
      "critical": "24h",
      "high": "7d",
      "medium": "30d",
      "low": "90d"
    },
    "reverseSync": {
      "enabled": true,
      "feedbackType": "improvement-share",
      "autoCreatePr": true,
      "requireCleanPatch": true,
      "branchPrefix": "fleet/feedback-"
    }
  }
}
